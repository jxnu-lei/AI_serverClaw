import{C as e,D as t,E as n,F as r,H as i,I as ee,K as te,N as a,O as o,P as ne,R as s,T as c,U as re,V as l,W as u,b as d,d as ie,g as ae,i as f,j as p,k as m,m as oe,o as se,p as ce,s as le,w as ue,x as de,z as h}from"./index-md6nwtnd.js";import{t as g}from"./_plugin-vue_export-helper-CSBScHBl.js";import{t as _}from"./api-BFhxd5g9.js";var fe={class:`chat-history-container`},pe={class:`page-header`},me={class:`header-actions`},he={class:`session-title`},ge={class:`pagination-wrapper`},v={key:0,class:`session-detail`},y={class:`detail-meta`},b={class:`messages-timeline`},x={key:0,class:`msg-bubble user-bubble`},S={class:`msg-header`},C={class:`msg-time`},w={class:`msg-content`},T={key:1,class:`msg-bubble ai-bubble`},E={class:`msg-header`},D={class:`msg-time`},O={key:0,class:`msg-content`},k={key:1,class:`msg-command-suggest`},A={key:2,class:`msg-bubble command-bubble`},j={class:`msg-header`},M={class:`msg-time`},N={class:`msg-command`},P={key:3,class:`msg-bubble output-bubble`},F={class:`msg-header`},I={class:`msg-time`},L={class:`msg-output`},_e={key:4,class:`msg-bubble system-bubble`},ve={class:`msg-content`},R=20,z=g(m({__name:`ChatHistoryView`,setup(te){let m=l([]),g=l(!1),z=l(``),B=l(``),V=l(1),H=l(0),U=l(!1),W=l(null),G=null,K=async()=>{g.value=!0;try{let e={page:V.value,page_size:R};B.value&&(e.status=B.value),z.value&&(e.search=z.value);let t=await _.get(`/api/chat-history/sessions`,{params:e}),n=t.data||t;m.value=n.items||[],H.value=n.total||0}catch{f.error(`加载历史记录失败`)}finally{g.value=!1}},ye=()=>{G&&clearTimeout(G),G=setTimeout(()=>{V.value=1,K()},300)},q=async e=>{try{let t=await _.get(`/api/chat-history/sessions/${e.id}`);W.value=t.data||t,U.value=!0}catch{f.error(`加载会话详情失败`)}},be=async e=>{try{await _.delete(`/api/chat-history/sessions/${e}`),f.success(`删除成功`),K()}catch{f.error(`删除失败`)}},J=e=>e?e<60?`${e}秒`:e<3600?`${Math.floor(e/60)}分${e%60}秒`:`${Math.floor(e/3600)}时${Math.floor(e%3600/60)}分`:`-`,Y=e=>e?new Date(e).toLocaleString(`zh-CN`):`-`,xe=e=>e?e.length>2e3?e.slice(0,2e3)+`
... (输出已截断)`:e:``;return p(()=>K()),(te,l)=>{let f=r(`el-icon`),p=r(`el-input`),_=r(`el-option`),G=r(`el-select`),X=r(`el-table-column`),Z=r(`el-tag`),Q=r(`el-button`),Se=r(`el-popconfirm`),Ce=r(`el-table`),we=r(`el-pagination`),$=r(`el-descriptions-item`),Te=r(`el-descriptions`),Ee=r(`el-dialog`),De=ee(`loading`);return a(),n(`div`,fe,[e(`div`,pe,[l[5]||=e(`h1`,null,`对话历史`,-1),e(`div`,me,[o(p,{modelValue:z.value,"onUpdate:modelValue":l[0]||=e=>z.value=e,placeholder:`搜索会话...`,clearable:``,style:{width:`250px`},onInput:ye},{prefix:s(()=>[o(f,null,{default:s(()=>[o(i(oe))]),_:1})]),_:1},8,[`modelValue`]),o(G,{modelValue:B.value,"onUpdate:modelValue":l[1]||=e=>B.value=e,placeholder:`状态`,clearable:``,style:{width:`120px`},onChange:K},{default:s(()=>[o(_,{label:`全部`,value:``}),o(_,{label:`进行中`,value:`active`}),o(_,{label:`已完成`,value:`completed`})]),_:1},8,[`modelValue`])])]),h((a(),ue(Ce,{data:m.value,style:{width:`100%`},onRowClick:q},{default:s(()=>[o(X,{prop:`title`,label:`会话标题`,"min-width":`200`},{default:s(({row:t})=>[e(`div`,he,[o(f,null,{default:s(()=>[o(i(se))]),_:1}),e(`span`,null,u(t.title||`未命名会话`),1)])]),_:1}),o(X,{prop:`host`,label:`服务器`,width:`180`}),o(X,{prop:`message_count`,label:`消息数`,width:`80`,align:`center`}),o(X,{prop:`command_count`,label:`命令数`,width:`80`,align:`center`}),o(X,{prop:`status`,label:`状态`,width:`100`,align:`center`},{default:s(({row:e})=>[o(Z,{type:e.status===`active`?`success`:`info`,size:`small`},{default:s(()=>[t(u(e.status===`active`?`进行中`:`已完成`),1)]),_:2},1032,[`type`])]),_:1}),o(X,{prop:`duration`,label:`时长`,width:`100`},{default:s(({row:e})=>[t(u(J(e.duration)),1)]),_:1}),o(X,{prop:`created_at`,label:`时间`,width:`180`},{default:s(({row:e})=>[t(u(Y(e.created_at)),1)]),_:1}),o(X,{label:`操作`,width:`120`,fixed:`right`},{default:s(({row:e})=>[o(Q,{size:`small`,onClick:d(t=>q(e),[`stop`])},{default:s(()=>[...l[6]||=[t(`查看`,-1)]]),_:1},8,[`onClick`]),o(Se,{title:`确定删除？`,onConfirm:t=>be(e.id)},{reference:s(()=>[o(Q,{size:`small`,type:`danger`,onClick:l[2]||=d(()=>{},[`stop`])},{default:s(()=>[...l[7]||=[t(`删除`,-1)]]),_:1})]),_:1},8,[`onConfirm`])]),_:1})]),_:1},8,[`data`])),[[De,g.value]]),e(`div`,ge,[o(we,{"current-page":V.value,"onUpdate:currentPage":l[3]||=e=>V.value=e,"page-size":R,total:H.value,layout:`total, prev, pager, next`,onCurrentChange:K},null,8,[`current-page`,`total`])]),o(Ee,{modelValue:U.value,"onUpdate:modelValue":l[4]||=e=>U.value=e,title:W.value?.title||`会话详情`,width:`800px`,top:`5vh`},{default:s(()=>[W.value?(a(),n(`div`,v,[e(`div`,y,[o(Te,{column:3,border:``,size:`small`},{default:s(()=>[o($,{label:`服务器`},{default:s(()=>[t(u(W.value.host),1)]),_:1}),o($,{label:`用户`},{default:s(()=>[t(u(W.value.username),1)]),_:1}),o($,{label:`状态`},{default:s(()=>[o(Z,{type:W.value.status===`active`?`success`:`info`,size:`small`},{default:s(()=>[t(u(W.value.status===`active`?`进行中`:`已完成`),1)]),_:1},8,[`type`])]),_:1}),o($,{label:`消息数`},{default:s(()=>[t(u(W.value.message_count),1)]),_:1}),o($,{label:`命令数`},{default:s(()=>[t(u(W.value.command_count),1)]),_:1}),o($,{label:`时长`},{default:s(()=>[t(u(J(W.value.duration)),1)]),_:1})]),_:1})]),e(`div`,b,[(a(!0),n(de,null,ne(W.value.messages,r=>(a(),n(`div`,{key:r.id,class:re([`message-item`,`message-${r.role}`,`type-${r.message_type}`])},[r.role===`user`?(a(),n(`div`,x,[e(`div`,S,[o(f,null,{default:s(()=>[o(i(ae))]),_:1}),l[8]||=e(`span`,null,`用户`,-1),e(`span`,C,u(Y(r.timestamp)),1)]),e(`div`,w,u(r.content),1)])):r.role===`assistant`?(a(),n(`div`,T,[e(`div`,E,[o(f,null,{default:s(()=>[o(i(ie))]),_:1}),l[9]||=e(`span`,null,`AI助手`,-1),e(`span`,D,u(Y(r.timestamp)),1)]),r.ai_explanation?(a(),n(`div`,O,u(r.ai_explanation),1)):c(``,!0),r.ai_suggested_command?(a(),n(`div`,k,[l[10]||=e(`span`,{class:`suggest-label`},`建议命令：`,-1),e(`code`,null,u(r.ai_suggested_command),1)])):c(``,!0)])):r.role===`command`?(a(),n(`div`,A,[e(`div`,j,[o(f,null,{default:s(()=>[o(i(ce))]),_:1}),l[11]||=e(`span`,null,`命令`,-1),o(Z,{type:r.command_status===`executed`?`success`:r.command_status===`rejected`?`danger`:`warning`,size:`small`},{default:s(()=>[t(u(r.command_status===`executed`?`已执行`:r.command_status===`rejected`?`已拒绝`:`已修改`),1)]),_:2},1032,[`type`]),e(`span`,M,u(Y(r.timestamp)),1)]),e(`div`,N,[e(`code`,null,u(r.command),1)])])):r.role===`output`?(a(),n(`div`,P,[e(`div`,F,[o(f,null,{default:s(()=>[o(i(le))]),_:1}),l[12]||=e(`span`,null,`输出`,-1),e(`span`,I,u(Y(r.timestamp)),1)]),e(`pre`,L,u(xe(r.command_output||r.content)),1)])):(a(),n(`div`,_e,[e(`div`,ve,u(r.content),1)]))],2))),128))])])):c(``,!0)]),_:1},8,[`modelValue`,`title`])])}}}),[[`__scopeId`,`data-v-04e72257`]]);export{z as default};